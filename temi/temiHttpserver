package com.example.temicontrolapp;

// import com.robotemi.sdk.communication.TtsRequest;  // ì£¼ì„ì²˜ë¦¬ (Temi SDK ì—°ë™ í›„ ë‹¤ì‹œ ì‚¬ìš© ê°€ëŠ¥)
import com.robotemi.sdk.Robot;
import java.io.IOException;
import java.net.*;
import java.util.Enumeration;
import fi.iki.elonen.NanoHTTPD;

public class TemiHttpServer extends NanoHTTPD {

    public TemiHttpServer() throws IOException {
        super(8080);
        start(SOCKET_READ_TIMEOUT, false);
        System.out.println("âœ… Temi ì„œë²„ ì‹œì‘ë¨: http://192.168.35.173:5555/speak");
    }

    @Override
    public Response serve(IHTTPSession session) {
        String uri = session.getUri();
        System.out.println("ğŸ“¡ ìš”ì²­ ë°›ìŒ: " + uri);

        if (uri.equals("/speak")) {
            // Robot.getInstance().speak(TtsRequest.create("ì™¸ë¶€ì—ì„œ ëª…ë ¹ ë„ì°©!", false));  // Temi SDK ì—°ë™ í›„ ì£¼ì„ í•´ì œ ì˜ˆì •
            System.out.println("âœ… Temi speak ìš”ì²­ (í˜„ì¬ëŠ” ì£¼ì„ì²˜ë¦¬ ìƒíƒœ)");
            return newFixedLengthResponse("Temiê°€ speak ëª…ë ¹ ë°›ìŒ (í˜„ì¬ëŠ” í…ŒìŠ¤íŠ¸ìš©)");
        } else if (uri.equals("/move")) {
            Robot.getInstance().goTo("home base");
            return newFixedLengthResponse("Temiê°€ move ëª…ë ¹ ë°›ìŒ");
        } else {
            return newFixedLengthResponse("â— ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹: " + uri);
        }
    }

    private String getDeviceIpAddress() {
        try {
            for (Enumeration<NetworkInterface> en = NetworkInterface.getNetworkInterfaces(); en.hasMoreElements();) {
                NetworkInterface intf = en.nextElement();
                for (Enumeration<InetAddress> enumIpAddr = intf.getInetAddresses(); enumIpAddr.hasMoreElements();) {
                    InetAddress inetAddress = enumIpAddr.nextElement();
                    if (!inetAddress.isLoopbackAddress() && inetAddress instanceof Inet4Address) {
                        return inetAddress.getHostAddress();
                    }
                }
            }
        } catch (SocketException ex) {
            ex.printStackTrace();
        }
        return "localhost";
    }
}



í…ŒìŠ¤íŠ¸ ì„œë²„

server.py

import socket
import os
import subprocess
import threading

HOST = '0.0.0.0'
PORT = 12345
BUFFER_SIZE = 1024

def run_chat_script():
    venv_python = os.path.abspath(os.path.join(os.getcwd(), "..", "tts_venv", "Scripts", "python.exe"))
    script_path = os.path.join(os.getcwd(), "realtime_chat_withGPT.py")

    if not os.path.exists(venv_python):
        print(f"â— Python ì‹¤í–‰ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {venv_python}")
        return
    if not os.path.exists(script_path):
        print(f"â— ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {script_path}")
        return

    try:
        print("ğŸ¬ 'realtime_chat_withGPT.py' ì‹¤í–‰ ì¤‘ (ë¹„ì°¨ë‹¨)...")
        subprocess.Popen([venv_python, script_path])
    except Exception as e:
        print(f"â— 'realtime_chat_withGPT.py' ì‹¤í–‰ ì‹¤íŒ¨: {e}")

def main():
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.bind((HOST, PORT))
    server_socket.listen(5)
    server_socket.settimeout(1.0)

    print(f"âœ… ì„œë²„ ì‹¤í–‰ ì¤‘ (í¬íŠ¸ {PORT})")

    try:
        while True:
            print("ğŸ’¤ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ëŒ€ê¸° ì¤‘...")
            try:
                client_socket, addr = server_socket.accept()
            except socket.timeout:
                continue
            except KeyboardInterrupt:
                raise

            print(f"ğŸ”— í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨: {addr}")
            client_socket.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)

            try:
                while True:
                    data = client_socket.recv(BUFFER_SIZE)
                    if not data:
                        print("âš ï¸ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ ê°ì§€.")
                        break

                    message = data.decode('utf-8').strip()
                    print(f"ğŸ“¨ ë°›ì€ ë©”ì‹œì§€: {message}")

                    if message == "speak":
                        # ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰í•˜ì—¬ ì„œë²„ ë©ˆì¶¤ ë°©ì§€
                        threading.Thread(target=run_chat_script, daemon=True).start()
                        client_socket.sendall("ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘\n".encode('utf-8'))
                        response = f"ì„œë²„ê°€ ë©”ì‹œì§€ ë°›ìŒ: {message}\n"
                        client_socket.sendall(response.encode('utf-8'))

                    elif message == "move":
                        response = f"ë„ìŠ¨íŠ¸ ë¡œë´‡ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.\n"
                        client_socket.sendall(response.encode('utf-8'))

                    elif message == "exit":
                        print("âŒ í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ ìš”ì²­ ë°›ìŒ. ì—°ê²° ì¢…ë£Œ.")
                        break

            except Exception as e:
                print(f"â— í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            finally:
                client_socket.close()
                print("ğŸ”„ í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ ë‹«í˜. ë‹¤ìŒ ì—°ê²° ëŒ€ê¸° ì¤‘...\n")

    except KeyboardInterrupt:
        print("\nğŸ›‘ ì„œë²„ ê°•ì œ ì¢…ë£Œ ìš”ì²­ ê°ì§€ (Ctrl + C). ì„œë²„ ì†Œì¼“ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    finally:
        server_socket.close()
        print("âœ… ì„œë²„ ì¢…ë£Œ ì™„ë£Œ.")

if __name__ == "__main__":
    main()
